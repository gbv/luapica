<!doctype html>
<html>
  <head>
    <title>PICA+ editor</title>
    <link rel="stylesheet" href="codemirror/codemirror.css">
    <script src="codemirror/codemirror.js"></script>
    <link rel="stylesheet" href="pica.css">
    <script src="pica.js"></script>
    <script src="codemirror/lua.js"></script>
    <link rel="stylesheet" href="codemirror/lua.css">
    <link rel="stylesheet" href="picaedit.css">
    <style type="text/css"> 
      .searched { background: #FFFFCC; } 
      #code span { margin-left: 0.5em; }
      .toolbar {
        width:100%; 
        background: #eee;
        color: #333;
        margin:0; padding:0;
        line-height: 1em;
        font-size: 14px;
      }
      .button {
        -moz-border-radius: 3px 3px 3px 3px;
        border: 1px solid #D4D4D4;
        color: #666666;
        background: #eee;
      }
      .button:hover {
          background: blue; color: #fff;
      }
    </style> 
    <script src="jquery-1.6.min.js"></script>
  </head>
  <body>
    <h1>PICA+ transformation with Lua</h1>
    <p>
      edit, copy &amp; paste <b>PICA+ data</b> in the 
      following field with syntax highlighting:
    </p>
    <form>
     <textarea id="picaedit" name="picaedit">
003@ $0123456789
019@ $aXA-DE
021A $aDas @Beispiel mit $$-Zeichen
028C/01 $dMax$aMusterfrau$9a54321$8Musterfrau, Max
099Z $0test$1test$Atest$Ztest
101@ $a23$cPICA
203@/01 $09875
101@ $a23$cPICA
203@/99 $056321
123X $ax
</textarea></form>
<!--
001@ $0x
204@/99 $xfoo
This is an error
123A This also
123X/ $ax
-->
<div class="toolbar">
    &#xA0;&#xA0;
  Find field: 
  <input type=text style="width: 8em" id="locator" value="003" 
         onkeyup="locate(document.getElementById('locator').value)"> 
  <!--<a class="undo"><img src="undo.gif"/></a/>
  <a class="redo"><img src="redo.gif"/></a/>
  <button type=button onclick="search()">Search</button> 
  <input type=text style="width: 5em" id=query value=indent> -->
  <!--button type=button onclick="locate()">locate fields</button--> 
    &#xA0;&#xA0;
    <tt id="code">
      <span class="pica-tag">&#xA0;</span><span class="pica-sf">&#xA0;</span><span class="pica-value">&#xA0;</span>
    </tt>
</div>
    <script>

//var picahighlines = [];

function analyzeCursor() {
  var editor = picaedit;

  //for (var i = 0; i < editor.lineCount(); ++i) editor.setLineClass(i,null);

  var p = PICAEdit.getFromCursor(picaedit);
  var node = document.getElementById("code");
  
  node.childNodes[1].setAttribute("class",p.type);
  node.childNodes[1].firstChild.nodeValue = p.tag;
  node.childNodes[2].firstChild.nodeValue = p.sf;
  node.childNodes[3].firstChild.nodeValue = p.value;
}

// create PICA+ editor
var picaedit = CodeMirror.fromTextArea(document.getElementById("picaedit"), {
    lineNumbers: true, onCursorActivity: analyzeCursor,
    mode: "pica"
});

// highlight fields: TODO: improve performance and also locate tags
function locate(q) {
  var editor = picaedit;
  for (var i = 0; i < editor.lineCount(); ++i) editor.setLineClass(i,null);
  if (!q) return;
  if (PICAEdit.tagpattern.exec(q)) {
    for (var i = 0; i < editor.lineCount(); ++i) {
      var token = editor.getTokenAt({line:i,ch:1});
      if (token.className="pica-tag" && token.string==q) {
        editor.setLineClass(i,"pica-highline");
      }
    }
  }
}

// search and replace
var lastPos = null, lastQuery = null, marked = [];
 
function unmark() {
  for (var i = 0; i < marked.length; ++i) marked[i]();
  marked.length = 0;
}

function search() {
  unmark();                     
  var text = document.getElementById("query").value;
  if (!text) return;
  for (var cursor = picaedit.getSearchCursor(text); cursor.findNext();)
    marked.push(picaedit.markText(cursor.from(), cursor.to(), "searched"));
 
  if (lastQuery != text) lastPos = null;
  var cursor = picaedit.getSearchCursor(text, lastPos || picaedit.getCursor());
  if (!cursor.findNext()) {
    cursor = picaedit.getSearchCursor(text);
    if (!cursor.findNext()) return;
  }
  picaedit.setSelection(cursor.from(), cursor.to());
  lastQuery = text; lastPos = cursor.to();
}

      </script>

  <p>edit, copy &amp; paste <b>lua transformation script</b> 
     (partial syntax highlighting).
      see <a href="https://github.com/nichtich/luapica/wiki">luapica wiki</a> 
      for help:
  </p>

  <form onsubmit="executeLua(); return false">
    <textarea id="luaedit" name="luaedit">
print(record)
print()
print(record["021A"])
print("PPN: "..record["003@$0"])

dc, errors = record:map {
   title    = '!021A $a',    -- must be exactely one value
   authors  = '*028C/xx $8', -- optional any number of values
   language = '010@$a',      -- first matching value, if any  
   subject  = "+041A/xx $8"  -- at least one subject
}
print(dc.title)
if dc.authors then
   local authors = table.concat(dc.authors,", ")
   print("Authors: "..authors)
end
if (errors) then
   for field,msg in pairs(errors) do
       print("ERROR: "..field.." "..msg)
   end
end
  </textarea>
  <p>
  <input type="button" class="button" value="transform" onClick="executeLuaServer();"/>
  <span id="scriptstatus">&#x21E0; click to transform via lua script!</span>
  </p>
</form>
<form>
 <textarea id="output">
 </textarea>
</form>
<script>

function analyzeLuaCursor() {
    var sel = luaedit.getSelection();
    if (sel && sel.match(/^[0-2][0-9][0-9][A-Z@]$/)) {
        locate(sel);
    } else {
        locate(false);
    }
}
// create Lua editor
var luaedit = CodeMirror.fromTextArea(document.getElementById("luaedit"), {
    lineNumbers: true, onCursorActivity: analyzeLuaCursor,
    mode: "lua"
});
var errorLine;

// create Lua editor
var outputedit = CodeMirror.fromTextArea(document.getElementById("output"), {
    lineNumbers: false, mode: "text/plain", readOnly: true
});

function executeLuaServer() {
    var data = {
        "lua" : luaedit.getValue(),
        "pica": picaedit.getValue(),
    };
    $.post( 'runluapica.php', data, function( result ) {
        if (typeof result != "object") {
            result = { "error" : "transformation failed" };
        }
        if (errorLine) {
            luaedit.clearMarker(errorLine);
            luaedit.setLineClass(errorLine,null);
        }
        if ( result.error && result.error != "" ) {
            $("#scriptstatus").show().removeClass("ok").addClass("error");
            $("#scriptstatus").text( result.error );
            result.line = parseInt(result.line);
            if ( result.line > 0 ) {
                errorLine = result.line - 1;
                luaedit.setLineClass(errorLine, "lua-errorline");
                luaedit.setMarker(errorLine,"","lua-errormark");
            }
        } else {
            $("#scriptstatus").show().removeClass("error").addClass("ok");
            $("#scriptstatus").text( "ok" );
        }
        if (!result.out) result.out = "";
        outputedit.setValue( result.out );
    },"json");
}
</script>

    <div id="footer">
      <p>powered by <a href="http://codemirror.net/">CodeMirror</a> 
      (syntax highlighting)
      and <a href="http://jquery.com/">jQuery</a>, and
      <a href="https://github.com/nichtich/luapica">luapica</a>
      </p>
    </div>
  </body>
</html>
